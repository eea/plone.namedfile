Move code from plone.app.z3cform here here
to break a cyclic dependency.
[gforcada]
